<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>The Kepler Problem · DifferentialEquations.jl</title><meta name="title" content="The Kepler Problem · DifferentialEquations.jl"/><meta property="og:title" content="The Kepler Problem · DifferentialEquations.jl"/><meta property="twitter:title" content="The Kepler Problem · DifferentialEquations.jl"/><meta name="description" content="Documentation for DifferentialEquations.jl."/><meta property="og:description" content="Documentation for DifferentialEquations.jl."/><meta property="twitter:description" content="Documentation for DifferentialEquations.jl."/><meta property="og:url" content="https://docs.sciml.ai/DiffEqDocs/stable/examples/kepler_problem/"/><meta property="twitter:url" content="https://docs.sciml.ai/DiffEqDocs/stable/examples/kepler_problem/"/><link rel="canonical" href="https://docs.sciml.ai/DiffEqDocs/stable/examples/kepler_problem/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/favicon.ico" rel="icon" type="image/x-icon"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.png" alt="DifferentialEquations.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">DifferentialEquations.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">DifferentialEquations.jl: Efficient Differential Equation Solving in Julia</a></li><li><a class="tocitem" href="../../getting_started/">Getting Started with Differential Equations in Julia</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../../tutorials/faster_ode_example/">Code Optimization for Differential Equations</a></li><li><a class="tocitem" href="../../tutorials/advanced_ode_example/">Solving Large Stiff Equations</a></li><li><a class="tocitem" href="../../tutorials/sde_example/">Stochastic Differential Equations</a></li><li><a class="tocitem" href="../../tutorials/rode_example/">Random Ordinary Differential Equations</a></li><li><a class="tocitem" href="../../tutorials/dde_example/">Delay Differential Equations</a></li><li><a class="tocitem" href="../../tutorials/dae_example/">Differential Algebraic Equations</a></li><li><a class="tocitem" href="../../tutorials/jump_diffusion/">Jump Diffusion Equations</a></li><li><a class="tocitem" href="../../tutorials/bvp_example/">Boundary Value Problems</a></li></ul></li><li><span class="tocitem">Examples</span><ul><li><input class="collapse-toggle" id="menuitem-4-1" type="checkbox" checked/><label class="tocitem" for="menuitem-4-1"><span class="docs-label">Beginner</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../classical_physics/">Classical Physics Models</a></li><li><a class="tocitem" href="../conditional_dosing/">Conditional Dosing in Pharmacometrics</a></li><li class="is-active"><a class="tocitem" href>The Kepler Problem</a><ul class="internal"><li><a class="tocitem" href="#Manifold-Projection"><span>Manifold Projection</span></a></li></ul></li><li><a class="tocitem" href="../outer_solar_system/">Simulating the Outer Solar System</a></li><li><a class="tocitem" href="../min_and_max/">Finding Maxima and Minima of ODEs Solutions</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-2" type="checkbox"/><label class="tocitem" for="menuitem-4-2"><span class="docs-label">Advanced</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../spiking_neural_systems/">Spiking Neural Systems</a></li><li><a class="tocitem" href="../beeler_reuter/">An Implicit/Explicit CUDA-Accelerated Solver for the 2D Beeler-Reuter Model</a></li><li><a class="tocitem" href="../diffusion_implicit_heat_equation/">Solving the heat equation with diffusion-implicit time-stepping</a></li></ul></li></ul></li><li><span class="tocitem">Basics</span><ul><li><a class="tocitem" href="../../basics/overview/">Overview of DifferentialEquations.jl</a></li><li><a class="tocitem" href="../../basics/common_solver_opts/">Common Solver Options (Solve Keyword Arguments)</a></li><li><a class="tocitem" href="../../basics/solution/">Solution Handling</a></li><li><a class="tocitem" href="../../basics/plot/">Plot Functions</a></li><li><a class="tocitem" href="../../basics/integrator/">Integrator Interface</a></li><li><a class="tocitem" href="../../basics/problem/">Problem Interface</a></li><li><a class="tocitem" href="../../basics/faq/">Frequently Asked Questions</a></li><li><a class="tocitem" href="../../basics/compatibility_chart/">Solver Compatibility Chart</a></li></ul></li><li><span class="tocitem">Problem Types</span><ul><li><a class="tocitem" href="../../types/discrete_types/">Discrete Problems</a></li><li><a class="tocitem" href="../../types/ode_types/">ODE Problems</a></li><li><a class="tocitem" href="../../types/nonautonomous_linear_ode/">Non-autonomous Linear ODE / Lie Group Problems</a></li><li><a class="tocitem" href="../../types/dynamical_types/">Dynamical, Hamiltonian and 2nd Order ODE Problems</a></li><li><a class="tocitem" href="../../types/split_ode_types/">Split ODE Problems</a></li><li><a class="tocitem" href="../../types/steady_state_types/">Steady State Problems</a></li><li><a class="tocitem" href="../../types/bvp_types/">BVP Problems</a></li><li><a class="tocitem" href="../../types/sde_types/">SDE Problems</a></li><li><a class="tocitem" href="../../types/sdae_types/">SDAE Problems</a></li><li><a class="tocitem" href="../../types/rode_types/">RODE Problems</a></li><li><a class="tocitem" href="../../types/dde_types/">DDE Problems</a></li><li><a class="tocitem" href="../../types/sdde_types/">SDDE Problems</a></li><li><a class="tocitem" href="../../types/dae_types/">DAE Problems</a></li></ul></li><li><span class="tocitem">Solver Algorithms</span><ul><li><a class="tocitem" href="../../solvers/discrete_solve/">Discrete Solvers</a></li><li><a class="tocitem" href="../../solvers/ode_solve/">ODE Solvers</a></li><li><a class="tocitem" href="../../solvers/nonautonomous_linear_ode/">Non-autonomous Linear ODE / Lie Group ODE Solvers</a></li><li><a class="tocitem" href="../../solvers/dynamical_solve/">Dynamical, Hamiltonian, and 2nd Order ODE Solvers</a></li><li><a class="tocitem" href="../../solvers/split_ode_solve/">Split ODE Solvers</a></li><li><a class="tocitem" href="../../solvers/steady_state_solve/">Steady State Solvers</a></li><li><a class="tocitem" href="../../solvers/bvp_solve/">BVP Solvers</a></li><li><a class="tocitem" href="../../solvers/sde_solve/">SDE Solvers</a></li><li><a class="tocitem" href="../../solvers/sdae_solve/">SDAE Solvers</a></li><li><a class="tocitem" href="../../solvers/rode_solve/">RODE Solvers</a></li><li><a class="tocitem" href="../../solvers/dde_solve/">DDE Solvers</a></li><li><a class="tocitem" href="../../solvers/sdde_solve/">SDDE Solvers</a></li><li><a class="tocitem" href="../../solvers/dae_solve/">Mass Matrix and Fully Implicit DAE Solvers</a></li><li><a class="tocitem" href="../../solvers/benchmarks/">Solver Benchmarks</a></li></ul></li><li><span class="tocitem">Additional Features</span><ul><li><a class="tocitem" href="../../features/performance_overloads/">Jacobians, Gradients, etc.</a></li><li><a class="tocitem" href="../../features/diffeq_arrays/">DiffEq-Specific Array Types</a></li><li><a class="tocitem" href="../../features/diffeq_operator/">Matrix-Free Linear Operators with SciMLOperators.jl</a></li><li><a class="tocitem" href="../../features/noise_process/">Noise Processes</a></li><li><a class="tocitem" href="../../features/linear_nonlinear/">Specifying (Non)Linear Solvers and Preconditioners</a></li><li><a class="tocitem" href="../../features/dae_initialization/">DAE Initialization</a></li><li><a class="tocitem" href="../../features/callback_functions/">Event Handling and Callback Functions</a></li><li><a class="tocitem" href="../../features/callback_library/">Callback Library</a></li><li><a class="tocitem" href="../../features/ensemble/">Parallel Ensemble Simulations</a></li><li><a class="tocitem" href="../../features/io/">I/O: Saving and Loading Solution Data</a></li><li><a class="tocitem" href="../../features/low_dep/">Reduced Compile Time, Optimizing Runtime, and Low Dependency Usage</a></li><li><a class="tocitem" href="../../features/progress_bar/">Progress Bar Integration</a></li></ul></li><li><span class="tocitem">External Solver APIs</span><ul><li><a class="tocitem" href="../../api/sundials/">Sundials.jl</a></li><li><a class="tocitem" href="../../api/daskr/">DASKR.jl</a></li></ul></li><li><span class="tocitem">OrdinaryDiffEq.jl API</span><ul><li><a class="tocitem" href="../../api/ordinarydiffeq/">OrdinaryDiffEq.jl: ODE solvers and utilities</a></li><li><a class="tocitem" href="../../api/ordinarydiffeq/usage/">Usage</a></li><li><input class="collapse-toggle" id="menuitem-10-3" type="checkbox"/><label class="tocitem" for="menuitem-10-3"><span class="docs-label">Explicit Solvers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/ordinarydiffeq/explicit/Tsit5/">OrdinaryDiffEqTsit5</a></li><li><a class="tocitem" href="../../api/ordinarydiffeq/explicit/Verner/">OrdinaryDiffEqVerner</a></li><li><a class="tocitem" href="../../api/ordinarydiffeq/explicit/AdamsBashforthMoulton/">OrdinaryDiffEqAdamsBashforthMoulton</a></li><li><a class="tocitem" href="../../api/ordinarydiffeq/explicit/LowStorageRK/">OrdinaryDiffEqLowStorageRK</a></li><li><a class="tocitem" href="../../api/ordinarydiffeq/explicit/SSPRK/">OrdinaryDiffEqSSPRK</a></li><li><a class="tocitem" href="../../api/ordinarydiffeq/explicit/LowOrderRK/">OrdinaryDiffEqLowOrderRK</a></li><li><a class="tocitem" href="../../api/ordinarydiffeq/explicit/HighOrderRK/">OrdinaryDiffEqHighOrderRK</a></li><li><a class="tocitem" href="../../api/ordinarydiffeq/explicit/Feagin/">OrdinaryDiffEqFeagin</a></li><li><a class="tocitem" href="../../api/ordinarydiffeq/explicit/PRK/">OrdinaryDiffEqPRK</a></li><li><a class="tocitem" href="../../api/ordinarydiffeq/explicit/QPRK/">OrdinaryDiffEqQPRK</a></li><li><a class="tocitem" href="../../api/ordinarydiffeq/explicit/TaylorSeries/">OrdinaryDiffEqTaylorSeries</a></li><li><a class="tocitem" href="../../api/ordinarydiffeq/explicit/Extrapolation/">OrdinaryDiffEqExtrapolation</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-10-4" type="checkbox"/><label class="tocitem" for="menuitem-10-4"><span class="docs-label">Semi-Implicit Solvers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/ordinarydiffeq/semiimplicit/Rosenbrock/">OrdinaryDiffEqRosenbrock</a></li><li><a class="tocitem" href="../../api/ordinarydiffeq/semiimplicit/StabilizedRK/">OrdinaryDiffEqStabilizedRK</a></li><li><a class="tocitem" href="../../api/ordinarydiffeq/semiimplicit/ExponentialRK/">OrdinaryDiffEqExponentialRK</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-10-5" type="checkbox"/><label class="tocitem" for="menuitem-10-5"><span class="docs-label">Implicit Solvers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/ordinarydiffeq/implicit/SDIRK/">OrdinaryDiffEqSDIRK</a></li><li><a class="tocitem" href="../../api/ordinarydiffeq/implicit/FIRK/">OrdinaryDiffEqFIRK</a></li><li><a class="tocitem" href="../../api/ordinarydiffeq/implicit/BDF/">OrdinaryDiffEqBDF</a></li><li><a class="tocitem" href="../../api/ordinarydiffeq/implicit/Extrapolation/">OrdinaryDiffEqExtrapolation</a></li><li><a class="tocitem" href="../../api/ordinarydiffeq/implicit/PDIRK/">OrdinaryDiffEqPDIRK</a></li><li><a class="tocitem" href="../../api/ordinarydiffeq/implicit/Nordsieck/">OrdinaryDiffEqNordsieck</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-10-6" type="checkbox"/><label class="tocitem" for="menuitem-10-6"><span class="docs-label">IMEX Solvers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/ordinarydiffeq/imex/IMEXMultistep/">OrdinaryDiffEqIMEXMultistep</a></li><li><a class="tocitem" href="../../api/ordinarydiffeq/imex/StabilizedIRK/">OrdinaryDiffEqStabilizedIRK</a></li><li><a class="tocitem" href="../../api/ordinarydiffeq/imex/IMEXBDF/">OrdinaryDiffEqBDF</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-10-7" type="checkbox"/><label class="tocitem" for="menuitem-10-7"><span class="docs-label">Dynamical ODE Explicit Solvers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/ordinarydiffeq/dynamicalodeexplicit/RKN/">OrdinaryDiffEqRKN</a></li><li><a class="tocitem" href="../../api/ordinarydiffeq/dynamicalodeexplicit/SymplecticRK/">OrdinaryDiffEqSymplecticRK</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-10-8" type="checkbox"/><label class="tocitem" for="menuitem-10-8"><span class="docs-label">Semilinear ODE Solvers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/ordinarydiffeq/semilinear/ExponentialRK/">OrdinaryDiffEqExponentialRK</a></li><li><a class="tocitem" href="../../api/ordinarydiffeq/semilinear/Linear/">OrdinaryDiffEqLinear</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-10-9" type="checkbox"/><label class="tocitem" for="menuitem-10-9"><span class="docs-label">Mass Matrix DAE Solvers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/ordinarydiffeq/massmatrixdae/Rosenbrock/">OrdinaryDiffEqRosenbrock</a></li><li><a class="tocitem" href="../../api/ordinarydiffeq/massmatrixdae/BDF/">OrdinaryDiffEqBDF</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-10-10" type="checkbox"/><label class="tocitem" for="menuitem-10-10"><span class="docs-label">Fully Implicit DAE Solvers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/ordinarydiffeq/fullyimplicitdae/BDF/">OrdinaryDiffEqBDF</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-10-11" type="checkbox"/><label class="tocitem" for="menuitem-10-11"><span class="docs-label">Misc Solvers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/ordinarydiffeq/misc/">Miscellaneous Solvers</a></li></ul></li></ul></li><li><span class="tocitem">StochasticDiffEq.jl API</span><ul><li><a class="tocitem" href="../../api/stochasticdiffeq/">StochasticDiffEq.jl: SDE solvers and utilities</a></li><li><a class="tocitem" href="../../api/stochasticdiffeq/usage/">Usage</a></li><li><input class="collapse-toggle" id="menuitem-11-3" type="checkbox"/><label class="tocitem" for="menuitem-11-3"><span class="docs-label">Nonstiff Solvers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/stochasticdiffeq/nonstiff/basic_methods/">Basic Nonstiff Methods</a></li><li><a class="tocitem" href="../../api/stochasticdiffeq/nonstiff/sra_sri_methods/">SRA/SRI Methods - Stochastic Runge-Kutta</a></li><li><a class="tocitem" href="../../api/stochasticdiffeq/nonstiff/high_weak_order/">High Weak Order Methods</a></li><li><a class="tocitem" href="../../api/stochasticdiffeq/nonstiff/commutative_noise/">Commutative Noise Methods</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-11-4" type="checkbox"/><label class="tocitem" for="menuitem-11-4"><span class="docs-label">Stiff Solvers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/stochasticdiffeq/stiff/implicit_methods/">Implicit Methods for Stiff SDEs</a></li><li><a class="tocitem" href="../../api/stochasticdiffeq/stiff/split_step_methods/">Split-Step Methods for Fully Stiff Problems</a></li><li><a class="tocitem" href="../../api/stochasticdiffeq/stiff/stabilized_methods/">Stabilized Methods (SROCK Family)</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-11-5" type="checkbox"/><label class="tocitem" for="menuitem-11-5"><span class="docs-label">Jump Diffusion</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/stochasticdiffeq/jumpdiffusion/tau_leaping/">Tau-Leaping Methods for Jump-Diffusion</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-11-6" type="checkbox"/><label class="tocitem" for="menuitem-11-6"><span class="docs-label">Misc Solvers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/stochasticdiffeq/misc/">Miscellaneous Methods</a></li></ul></li></ul></li><li><span class="tocitem">Extra Details</span><ul><li><a class="tocitem" href="../../extras/timestepping/">Timestepping Method Descriptions</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li><a class="is-disabled">Beginner</a></li><li class="is-active"><a href>The Kepler Problem</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>The Kepler Problem</a></li></ul></nav><div class="docs-right"><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="The-Kepler-Problem"><a class="docs-heading-anchor" href="#The-Kepler-Problem">The Kepler Problem</a><a id="The-Kepler-Problem-1"></a><a class="docs-heading-anchor-permalink" href="#The-Kepler-Problem" title="Permalink"></a></h1><p>The (non-dimensional) Hamiltonian <span>$\mathcal {H}$</span> and the angular momentum <span>$L$</span> for the Kepler problem are</p><p class="math-container">\[\begin{align*}
\mathcal{H}(q_1, p_1, q_2, p_2) &amp;= \frac{1}{2}(p^2_1+p^2_2)-\frac{1}{\sqrt{q^2_1+q^2_2}}, \\
L &amp;= q_1 p_2 - p_1 q_2
\end{align*}\]</p><p>Also, we know that</p><p class="math-container">\[\begin{align*}
\frac{\mathrm{d} \boldsymbol{p}}{\mathrm{d} t} &amp;= - \frac {\partial \mathcal{H}}{\partial \boldsymbol{q}} , \\
\frac{\mathrm{d} \boldsymbol{q}}{\mathrm{d} t} &amp;= + \frac {\partial \mathcal{H}}{\partial \boldsymbol{p}}
\end{align*}\]</p><pre><code class="language-julia hljs">import OrdinaryDiffEq as ODE, ForwardDiff, Plots
import LinearAlgebra: norm
H(q, p) = norm(p)^2 / 2 - inv(norm(q))
L(q, p) = q[1] * p[2] - p[1] * q[2]

pdot(dp, p, q, params, t) = ForwardDiff.gradient!(dp, q -&gt; -H(q, p), q)
qdot(dq, p, q, params, t) = ForwardDiff.gradient!(dq, p -&gt; H(q, p), p)

initial_position = [0.4, 0]
initial_velocity = [0.0, 2.0]
initial_cond = (initial_position, initial_velocity)
initial_first_integrals = (H(initial_cond...), L(initial_cond...))
tspan = (0, 20.0)
prob = ODE.DynamicalODEProblem(pdot, qdot, initial_velocity, initial_position, tspan)
sol = ODE.solve(prob, ODE.KahanLi6(), dt = 1 // 10);</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">retcode: Success
Interpolation: 3rd order Hermite
t: 201-element Vector{Float64}:
  0.0
  0.1
  0.2
  0.30000000000000004
  0.4
  0.5
  0.6
  0.7
  0.7999999999999999
  0.8999999999999999
  ⋮
 19.200000000000003
 19.300000000000004
 19.400000000000006
 19.500000000000007
 19.60000000000001
 19.70000000000001
 19.80000000000001
 19.900000000000013
 20.0
u: 201-element Vector{RecursiveArrayTools.ArrayPartition{Float64, Tuple{Vector{Float64}, Vector{Float64}}}}:
 ([0.0, 2.0], [0.4, 0.0])
 ([-0.5830949354540153, 1.8556656829703986], [0.36982713146498514, 0.19503596514776078])
 ([-0.9788105843777312, 1.5274462532150213], [0.28987830863610903, 0.36495974735762693])
 ([-1.17547762665905, 1.1751394486895783], [0.18078065407309682, 0.4998457720618293])
 ([-1.2440239387295458, 0.8720450804540057], [0.05902925334751511, 0.6016956802132387])
 ([-1.2441259417439434, 0.6289994697149073], [-0.06577256855272472, 0.6762747102291482])
 ([-1.210142434136089, 0.4368770315976506], [-0.188677607179601, 0.7291942568591364])
 ([-1.159918613868923, 0.28408169071815415], [-0.30726896099260204, 0.7649583990935568])
 ([-1.1025329550493486, 0.16100716005909121], [-0.42042727561865095, 0.7869985179897889])
 ([-1.0426125487031446, 0.06047044972523817], [-0.5276934467175253, 0.7979089270264804])
 ⋮
 ([-1.2216434770974924, 1.0146166139269628], [0.12021680827049967, 0.5550113775144959])
 ([-1.2499499900381474, 0.7423750265723162], [-0.00391841642025021, 0.6423528468283755])
 ([-1.229831087369157, 0.5265058660314383], [-0.1281828192264333, 0.7053724817632377])
 ([-1.1861148292768198, 0.355578849211398], [-0.24911096207717606, 0.7491505605432118])
 ([-1.1314960903669982, 0.21881648422641656], [-0.3650489236780046, 0.7776241823022744])
 ([-1.0724336821492086, 0.10787192092145223], [-0.4752653800399116, 0.7937719633967358])
 ([-1.0122234000273318, 0.016617787590257133], [-0.5794991103107785, 0.7998530690972221])
 ([-0.9525349461453905, -0.059398567433266464], [-0.6777283550437248, 0.7976021348885333])
 ([-0.8941857396495508, -0.12343221924184411], [-0.7700512224747937, 0.7883718532084002])</code></pre><p>Let&#39;s plot the orbit and check the energy and angular momentum variation. We know that energy and angular momentum should be constant, and they are also called first integrals.</p><pre><code class="language-julia hljs">function plot_orbit(sol)
    Plots.plot(sol, idxs = (3, 4), lab = &quot;Orbit&quot;, title = &quot;Kepler Problem Solution&quot;)
end

function plot_first_integrals(sol, H, L)
    Plots.plot(initial_first_integrals[1] .- map(u -&gt; H(u.x[2], u.x[1]), sol.u),
        lab = &quot;Energy variation&quot;, title = &quot;First Integrals&quot;)
    Plots.plot!(initial_first_integrals[2] .- map(u -&gt; L(u.x[2], u.x[1]), sol.u),
        lab = &quot;Angular momentum variation&quot;)
end
analysis_plot(sol, H, L) = Plots.plot(plot_orbit(sol), plot_first_integrals(sol, H, L))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">analysis_plot (generic function with 1 method)</code></pre><pre><code class="language-julia hljs">analysis_plot(sol, H, L)</code></pre><img src="24fa3fa7.svg" alt="Example block output"/><p>Let&#39;s try to use a Runge-Kutta-Nyström solver to solve this problem and check the first integrals&#39; variation.</p><pre><code class="language-julia hljs">sol2 = ODE.solve(prob, ODE.DPRKN6())  # dt is not necessary, because unlike symplectic
# integrators DPRKN6 is adaptive
@show sol2.u |&gt; length
analysis_plot(sol2, H, L)</code></pre><img src="e5377674.svg" alt="Example block output"/><p>Let&#39;s then try to solve the same problem by the <code>ERKN4</code> solver, which is specialized for sinusoid-like periodic function</p><pre><code class="language-julia hljs">sol3 = ODE.solve(prob, ODE.ERKN4()) # dt is not necessary, because unlike symplectic
# integrators ERKN4 is adaptive
@show sol3.u |&gt; length
analysis_plot(sol3, H, L)</code></pre><img src="a16188c7.svg" alt="Example block output"/><p>We can see that <code>ERKN4</code> does a bad job for this problem, because this problem is not sinusoid-like.</p><p>One advantage of using <code>DynamicalODEProblem</code> is that it can implicitly convert the second order ODE problem to a <em>normal</em> system of first order ODEs, which is solvable for other ODE solvers. Let&#39;s use the <code>Tsit5</code> solver for the next example.</p><pre><code class="language-julia hljs">sol4 = ODE.solve(prob, ODE.Tsit5())
@show sol4.u |&gt; length
analysis_plot(sol4, H, L)</code></pre><img src="11d13e83.svg" alt="Example block output"/><h4 id="Note"><a class="docs-heading-anchor" href="#Note">Note</a><a id="Note-1"></a><a class="docs-heading-anchor-permalink" href="#Note" title="Permalink"></a></h4><p>There is drifting for all the solutions, and high order methods are drifting less because they are more accurate.</p><h3 id="Conclusion"><a class="docs-heading-anchor" href="#Conclusion">Conclusion</a><a id="Conclusion-1"></a><a class="docs-heading-anchor-permalink" href="#Conclusion" title="Permalink"></a></h3><ul><li><ul><li><ul><li></li></ul></li></ul></li></ul><p>Symplectic integrator does not conserve the energy completely at all time, but the energy can come back. In order to make sure that the energy fluctuation comes back eventually, symplectic integrator has to have a fixed time step. Despite the energy variation, symplectic integrator conserves the angular momentum perfectly.</p><p>Both Runge-Kutta-Nyström and Runge-Kutta integrator do not conserve energy nor the angular momentum, and the first integrals do not tend to come back. An advantage Runge-Kutta-Nyström integrator over symplectic integrator is that RKN integrator can have adaptivity. An advantage Runge-Kutta-Nyström integrator over Runge-Kutta integrator is that RKN integrator has less function evaluation per step. The <code>ERKN4</code> solver works best for sinusoid-like solutions.</p><h2 id="Manifold-Projection"><a class="docs-heading-anchor" href="#Manifold-Projection">Manifold Projection</a><a id="Manifold-Projection-1"></a><a class="docs-heading-anchor-permalink" href="#Manifold-Projection" title="Permalink"></a></h2><p>In this example, we know that energy and angular momentum should be conserved. We can achieve this through manifold projection. As the name implies, it is a procedure to project the ODE solution to a manifold. Let&#39;s start with a base case, where manifold projection isn&#39;t being used.</p><div class="admonition is-info" id="Note-20b69c13e9677c33"><header class="admonition-header">Note<a class="admonition-anchor" href="#Note-20b69c13e9677c33" title="Permalink"></a></header><div class="admonition-body"><p>Note that NonlinearSolve.jl is required to be imported for ManifoldProjection</p></div></div><pre><code class="language-julia hljs">import DiffEqCallbacks as CB, NonlinearSolve as NLS

function plot_orbit2(sol)
    Plots.plot(sol, vars = (1, 2), lab = &quot;Orbit&quot;, title = &quot;Kepler Problem Solution&quot;)
end

function plot_first_integrals2(sol, H, L)
    Plots.plot(initial_first_integrals[1] .- map(u -&gt; H(u[1:2], u[3:4]), sol.u),
        lab = &quot;Energy variation&quot;, title = &quot;First Integrals&quot;)
    Plots.plot!(initial_first_integrals[2] .- map(u -&gt; L(u[1:2], u[3:4]), sol.u),
        lab = &quot;Angular momentum variation&quot;)
end

analysis_plot2(sol, H, L) = Plots.plot(plot_orbit2(sol), plot_first_integrals2(sol, H, L))

function hamiltonian(du, u, params, t)
    q, p = u[1:2], u[3:4]
    qdot(@view(du[1:2]), p, q, params, t)
    pdot(@view(du[3:4]), p, q, params, t)
end

prob2 = ODE.ODEProblem(hamiltonian, [initial_position; initial_velocity], tspan)
sol_ = ODE.solve(prob2, ODE.RK4(), dt = 1 // 5, adaptive = false)
analysis_plot2(sol_, H, L)</code></pre><img src="de3f7f99.svg" alt="Example block output"/><p>There is a significant fluctuation in the first integrals, when there is no manifold projection.</p><pre><code class="language-julia hljs">function first_integrals_manifold(residual, u, p, t)
    residual[1:2] .= initial_first_integrals[1] - H(u[1:2], u[3:4])
    residual[3:4] .= initial_first_integrals[2] - L(u[1:2], u[3:4])
end

cb = CB.ManifoldProjection(first_integrals_manifold, autodiff = NLS.AutoForwardDiff())
sol5 = ODE.solve(prob2, ODE.RK4(), dt = 1 // 5, adaptive = false, callback = cb)
analysis_plot2(sol5, H, L)</code></pre><img src="04fa7509.svg" alt="Example block output"/><p>We can see that thanks to the manifold projection, the first integrals&#39; variation is very small, although we are using <code>RK4</code> which is not symplectic. But wait, what if we only project to the energy conservation manifold?</p><pre><code class="language-julia hljs">function energy_manifold(residual, u, p, t)
    residual[1:2] .= initial_first_integrals[1] - H(u[1:2], u[3:4])
    residual[3:4] .= 0
end
energy_cb = CB.ManifoldProjection(energy_manifold, autodiff = NLS.AutoForwardDiff())
sol6 = ODE.solve(prob2, ODE.RK4(), dt = 1 // 5, adaptive = false, callback = energy_cb)
analysis_plot2(sol6, H, L)</code></pre><img src="1a0e3955.svg" alt="Example block output"/><p>There is almost no energy variation, but angular momentum varies quite a bit. How about only project to the angular momentum conservation manifold?</p><pre><code class="language-julia hljs">function angular_manifold(residual, u, p, t)
    residual[1:2] .= initial_first_integrals[2] - L(u[1:2], u[3:4])
    residual[3:4] .= 0
end
angular_cb = CB.ManifoldProjection(angular_manifold, autodiff = NLS.AutoForwardDiff())
sol7 = ODE.solve(prob2, ODE.RK4(), dt = 1 // 5, adaptive = false, callback = angular_cb)
analysis_plot2(sol7, H, L)</code></pre><img src="a44643be.svg" alt="Example block output"/><p>Again, we see what we expect.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../conditional_dosing/">« Conditional Dosing in Pharmacometrics</a><a class="docs-footer-nextpage" href="../outer_solar_system/">Simulating the Outer Solar System »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.16.1 on <span class="colophon-date" title="Monday 12 January 2026 05:36">Monday 12 January 2026</span>. Using Julia version 1.12.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
